name: 🤖 Claude Agent Dispatcher

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  run-agent:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' &&
       (contains(github.event.comment.body, '@claude') ||
        contains(github.event.comment.body, 'claude') ||
        contains(github.event.comment.body, 'optimize'))) ||
      (github.event_name == 'issues' &&
       (contains(github.event.issue.labels.*.name, 'claude-agent') ||
        contains(github.event.issue.labels.*.name, 'optimization') ||
        contains(github.event.issue.title, 'claude')))

    steps:
    - uses: actions/checkout@v4

    - name: 🐍 Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scipy pydantic fastapi uvicorn

    - name: 🚀 Execute Agent Task
      run: |
        echo "🚀 Executing optimization agent..."
        python3 ultimate_optimizer_50pts.py > agent_output.log 2>&1 || echo "Agent execution completed"

    - name: 📊 Post Results to Issue
      uses: actions/github-script@v6
      with:
        script: |
          const issueNumber = context.issue.number;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            body: '🤖 **Claude Agent Results**\n\n**Status**: ✅ Processing Complete\n**Task**: Optimization agent executed\n\n*🤖 Completed by GitHub Actions Cloud Agent*'
          });